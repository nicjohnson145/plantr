version: "3"

tasks:
  migration:
    desc: create a new migration
    preconditions:
    - sh: '[[ -n "${NAME}" ]]'
      msg: 'Must specify $NAME'
    cmds:
    - task: migrate-sqlite
      vars:
        NAME: "$NAME"

  migrate-sqlite:
    internal: true
    dir: internal/storage/sqlite-migrations
    cmds:
    - migrate create -ext sql {{ .NAME }}


  build-controller:
    desc: build the controller binary
    cmds:
    - CGO_ENABLED=0 go build -o plantr-controller ./cmd/controller

  run-controller:
    desc: run controller locally
    env:
      SQLITE_DB_PATH: "local.db"
      STORAGE_TYPE: "sqlite"
    cmds:
    - task: build-controller
    - ./plantr-controller